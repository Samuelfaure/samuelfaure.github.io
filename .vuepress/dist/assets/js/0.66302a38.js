(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{46:function(t,e,a){t.exports=a.p+"assets/img/dogesmall.7031bab2.jpg"},47:function(t,e,a){"use strict";a.r(e);var o=[function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"content"},[o("h1",{attrs:{id:"testing-ansible-scripts-without-breaking-everything-with-vagrant"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#testing-ansible-scripts-without-breaking-everything-with-vagrant","aria-hidden":"true"}},[t._v("#")]),t._v(" Testing ANSIBLE scripts without breaking everything with Vagrant")]),o("p",[o("img",{attrs:{src:a(46),alt:"logo"}}),t._v("\nTesting ANSIBLE scripts for server deployment might be tricky.\nIt is easier to write complex deployment scripts aimed to deploying on clean servers. The correlation is that your script might break a server which is not clean. You might need an empty server to try your script on.")]),o("p",[t._v("One solution is to subscribe for a free AWS server. But this solution is limited (time, available space).\nAnother solution is renting a cheap OVH server for 3.50 euros a month, but that might not be ideal either.")]),o("p",[t._v("A better solution is provisioning to virtual servers with Vagrant. This solution also have the benefit of being local, so we don’t even need internet for running tests on our ANSIBLE playbooks.")]),o("p",[t._v("In this example, we will provision with ANSIBLE a rails app on a virtual server, using Vagrant.")]),o("h2",{attrs:{id:"step-1-install-virtualbox-vagrant"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#step-1-install-virtualbox-vagrant","aria-hidden":"true"}},[t._v("#")]),t._v(" Step 1 : Install Virtualbox / Vagrant")]),o("p",[t._v("sudo apt-get install virtualbox\nsudo apt-get install vagrant\nStep 2 : Choose / execute your box")]),o("p",[t._v("List of boxes available here : https://app.vagrantup.com/boxes/search")]),o("p",[t._v("We will choose Ubuntu 16.04 (Xenial) :")]),o("p",[t._v("vagrant init ubuntu/xenial64\nYou should have a directory vagrant_virtual_drives in your home, containing a log and a Vagrantfile. Go here and execute :")]),o("p",[t._v("vagrant up\nCheck if everything works correctly by connecting to your virtual machine in SSH :")]),o("p",[t._v("vagrant ssh\nStep 3 : configuring Vagrantfile for being provisioned by ANSIBLE / Forwarding Rails port 3000")]),o("p",[t._v("Add this to your Vagrantfile :")]),o("p",[t._v("Vagrant.configure(“2”) do |config|")]),o("h1",{attrs:{id:"forward-port-3000-to-localhost-so-you-can-access-your-rails-app-in-your-browser"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#forward-port-3000-to-localhost-so-you-can-access-your-rails-app-in-your-browser","aria-hidden":"true"}},[t._v("#")]),t._v(" Forward port 3000 to localhost so you can access your rails app in your browser")]),o("p",[t._v("config.vm.network “forwarded_port”, guest: 3000, host: 3000, host_ip: “127.0.0.1”")]),o("h1",{attrs:{id:"allowing-your-virtual-machine-to-be-provisioned-by-ansible"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#allowing-your-virtual-machine-to-be-provisioned-by-ansible","aria-hidden":"true"}},[t._v("#")]),t._v(" Allowing your virtual machine to be provisioned by ANSIBLE")]),o("p",[t._v("config.vm.provision “ansible” do |ansible|\nansible.playbook = “playbook.yml”\nend\nend\nStep 4 : Provisioning your Vagrant virtual machine")]),o("p",[t._v("Add your virtual machine to your ANSIBLE inventory :")]),o("h1",{attrs:{id:"myansible-inventories-my-virtual-machine"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#myansible-inventories-my-virtual-machine","aria-hidden":"true"}},[t._v("#")]),t._v(" MyAnsible/inventories/my_virtual_machine")]),o("p",[t._v("[my-virtual-machine]")]),o("p",[t._v("127.0.0.1 ansible_port=2222 ansible_user=YourBoxUser ansible_ssh_pass=YourSSHPassword\nThe IP 127.0.0.1 as well as the port (2222) are default for this box. When you vagrant up you can check if the values are correct (you can also check by running vagrant ssh-config).")]),o("p",[t._v("Don’t forget to replace YourBoxUser and YourSSHPassword. For most vagrant boxes, it should both be “vagrant”. However, for the ubuntu/Xenial box and some others, the password is randomized for security reasons. You can check the username and password in your box default settings :")]),o("p",[t._v("cat ~/.vagrant.d/boxes/ubuntu-VAGRANTSLASH-xenial64/20171011.0.0/virtualbox")]),o("p",[t._v("20171011.0.0 is the date/version of the current box you’re using. I’m writing this mid-october. On this box, YourBoxUser should be “ubuntu”.")]),o("p",[t._v("Deploy your ansible to your virtual machine :")]),o("p",[t._v("ansible-playbook MyPlaybook.yml -i inventories/my_virtual_machine\nIf all goes well, your deployment should start.\nYou might get the following error :")]),o("p",[t._v("fatal: [127.0.0.1]: FAILED! => {“failed”: true, “msg”: “Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this. Please add this host’s fingerprint to your known_hosts file to manage this host.”}")]),o("p",[t._v("In that case, either manually connect with SSH first : ssh YourBoxUser@127.0.0.1 -p 2222 (you will be prompted for YourSSHPassword)\nYou should be asked to validate a key fingerprint, accept it and you’re done.")]),o("p",[t._v("Another way to solve this error is creating in your ansible directory an ansible.cfg file with :")]),o("p",[t._v("[defaults]\nhost_key_checking = false\nThe error should be gone.")]),o("p",[t._v("Another problem might be the absence of Python 2 on your box. If that happens, create a ANSIBLE playbook to install python without python being installed :")]),o("h1",{attrs:{id:"python-dirty-install-yml"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#python-dirty-install-yml","aria-hidden":"true"}},[t._v("#")]),t._v(" python-dirty-install.yml")]),o("ul",[o("li",[o("p",[t._v("hosts: all\ngather_facts: False\nbecome: True")]),o("p",[t._v("tasks:")]),o("ul",[o("li",[t._v("name: install python 2\nraw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)\nRun it with ansible-playbook python-dirty-install.yml -i inventories/my-virtual-machine. You should now be able to use your other playbook.")])])])]),o("p",[t._v("Step 5 : Running your Rails server")]),o("p",[t._v("If you did your deployment script properly, you should have your app folder on your virtual machine. Go there and launch your rails server. You need to start puma on a different port (3001) and rails on port 3000 :")]),o("p",[t._v("bundle exec puma -C config/puma.rb -b tcp://127.0.0.1:3001\nsudo rails server -p 3000 -b 0.0.0.0\nConnect locally to http://localhost:3000/ . Congratulations, you are on Rails !")]),o("p",[t._v("You can stop your vagrant virtual machine with vagrant halt if you want to keep it in its current state, or vagrant destroy to destroy it completely.")]),o("p",[t._v("If you learned something in this tutorial, please write a little “Wow!” in the comments below.")])])}],r=a(0),n=Object(r.a)({},function(){this.$createElement;this._self._c;return this._m(0)},o,!1,null,null,null);e.default=n.exports}}]);